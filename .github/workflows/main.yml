name: Terraform utilizando OpenID Connect
on: 
  push:
    branches:
     - main
  pull_request:
    branches:
     - main
  workflow_dispatch:

permissions:
      id-token: write
      contents: read
      pull-requests: write
      
jobs: 
  analysis:
    if: github.event_name == 'pull_request'
    defaults:
      run:
        working-directory: terraform-deploy
    name: Analyse the Terraform
    environment: dev
  runs-on: ubuntu-latest
steps:    
  - name: 'Az CLI login'
    uses: azure/login@v1
    with:
      client-id: ${{ secrets.AZURE_CLIENT_ID }}
      tenant-id: ${{ secrets.AZURE_TENANT_ID }}
      subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  - name: 'Run Azure CLI commands'
    run: |
         az account show
         az group list

    steps:
  - name: Checkout Code
    uses: actions/checkout@v2.5.0

  - name: HashiCorp - Setup Terraform
    uses: hashicorp/setup-terraform@v2.0.3

  - name: Terraform Fmt
    run: terraform fmt -check

  - name: Terraform Init
    run: terraform init